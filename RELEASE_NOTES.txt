This version fixes bugs and improves performance.